/*
 * alphavantage ticker device
 */
import groovy.json.JsonSlurper

metadata {
	definition(name: "my.stockticker", namespace: "leosperry", author: "Leonard Sperry"
               /*, importUrl: "https://raw.githubusercontent.com/staze/hubitat-gmcmap/master/hubitat-gmcmap.groovy"*/
              ) {
		capability "Sensor"
		capability "Polling"
		attribute "Low", "NUMBER"
		attribute "High", "NUMBER"
		attribute "Price", "NUMBER"
	}
}

preferences {
	section("URIs") {
		input name: "ApiKey", type: "text", title: "API Key", required: true
        input name: "Symbol", type: "text", title: "Symbol", required: true
	}
}

def logsOff() {
	log.warn "debug logging disabled..."
	device.updateSetting("logEnable", [value: "false", type: "bool"])
}

def updated() {
	unschedule()
	log.info "gmcmap updated..."
	log.warn "debug logging is: ${logEnable == true}"
	if (logEnable) runIn(1800, logsOff)
	if(updateMins != "0") {
		schedule("0 */${updateMins} * ? * *", poll)
	}
	
}

def parse(String description) {
	if (logEnable) log.debug(description)
}

def poll() {
	if (logEnable) log.debug "gmcmap polling..."
    //def url = "http://www.gmcmap.com/historyData-plain.asp?Param_ID=${GeigerID}&timezone=${Timezone}"
	//def url = "https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=ENV&apikey=BUZNUKC0JHBP63HF"
    def url = "https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${Symbol}&apikey=${ApiKey}"
	try {
		httpGet(url) { resp -> 
			if (logEnable) log.debug resp.getData()
			
            def respValues = resp.data["Global Quote"]
			sendEvent(name: "Low", value: respValues["04. low"])
			sendEvent(name: "High", value: respValues["03. high"])
			sendEvent(name: "Price", value: respValues["05. price"])
			
            //log.info respValues.CPM + " CPM, " + respValues.ACPM + " ACPM, " + respValues.uSv + " uSv"
		}
	} catch(Exception e) {
		log.debug "error occured calling httpget ${e}"
	}
}
